# N8N Workflow 4 & 5 Frontend Implementation

## Overview
This document describes the frontend implementation for displaying AI attendance scores (Workflow 4) and managing daily PDF reports (Workflow 5) from N8N integration.

---

## ✅ Workflow 4: AI Attendance Score Display

### Student Dashboard
**File:** `frontend/app/(dashboard)/student/page.tsx`

**Features:**
- **AI Score Card**: Displays when `ai_score` is available from backend
- **Visual Indicators**: 
  - Green (≥80): Excellent attendance
  - Amber (60-79): Needs improvement
  - Red (<60): Critical attention required
- **Progress Bar**: Animated visual representation of score
- **AI Explanation**: Full text explanation from OpenRouter API
- **Auto-refresh**: Score updates when N8N Workflow 4 runs (daily at 6 PM)

**Component Structure:**
```tsx
{stats?.ai_score !== null && stats?.ai_score !== undefined && (
  <div className="rounded-xl border border-purple-500/30 bg-gradient-to-br from-purple-600/20 to-pink-600/20 p-6">
    {/* Score display with color-coded indicators */}
    {/* AI explanation text */}
    {/* Animated progress bar */}
  </div>
)}
```

**API Endpoint:** `GET /api/student/stats`
**Response Fields:**
- `ai_score`: Integer (0-100) - AI-calculated attendance score
- `ai_explanation`: String - AI-generated explanation in natural language

---

### Admin Students Table
**File:** `frontend/app/(dashboard)/admin/students/page.tsx`

**Features:**
- **New Column**: "Score IA" added to student list table
- **Color-Coded Scores**: Same color scheme as student view
- **Quick View Button**: Sparkles icon (✨) to view full AI explanation
- **Inline Display**: Shows score directly in table without modal

**Column Implementation:**
```tsx
{
  header: 'Score IA',
  cell: ({ row }) => {
    const score = row.original.pourcentage;
    if (score === null || score === undefined) {
      return <span className="text-xs text-zinc-500">—</span>;
    }
    return (
      <div className="flex items-center gap-2">
        <span className={`font-semibold ${/* color based on score */}`}>
          {score}
        </span>
        {row.original.justification && (
          <button onClick={() => alert(`Explication IA:\n\n${row.original.justification}`)}>
            <Sparkles className="h-3 w-3" />
          </button>
        )}
      </div>
    );
  },
}
```

**API Endpoint:** `GET /api/admin/students`
**Response Fields (per student):**
- `pourcentage`: Integer (0-100) - AI score
- `justification`: String - AI explanation

---

## ✅ Workflow 5: Daily PDF Reports Management

### New Admin Page: Reports
**File:** `frontend/app/(dashboard)/admin/reports/page.tsx`
**Route:** `/admin/reports`

**Features:**
1. **Reports List**:
   - Displays all PDFs generated by N8N Workflow 5
   - Sorted by creation date (newest first)
   - Shows: class name, date, generation timestamp

2. **Class Filter**:
   - Dropdown to filter by specific class
   - "All classes" option to view everything

3. **Download Functionality**:
   - Click "Télécharger" button to download PDF
   - Browser triggers native download with proper filename
   - Format: `absences_{class}_{date}.pdf`

4. **Real-time Updates**:
   - Auto-refreshes every 30 seconds
   - Shows new PDFs as soon as N8N uploads them

5. **Info Card**:
   - Explains workflow schedule (11:59 PM daily)
   - Lists PDF contents (student names, parent emails, hours)
   - Shows storage location

**Component Structure:**
```tsx
<div className="divide-y divide-white/5">
  {filteredReports.map((report) => (
    <div className="flex items-center justify-between p-4">
      <div>
        <h3>Absences - {report.class}</h3>
        <div>
          <Calendar /> {report.date}
          <Clock /> Generated {report.created_at}
        </div>
      </div>
      <button onClick={() => handleDownload(report)}>
        <Download /> Télécharger
      </button>
    </div>
  ))}
</div>
```

---

## Backend Endpoints Created

### 1. AI Score Exposure
**Modified Files:**
- `backend/app/api/routes/student.py` - Added `ai_score` and `ai_explanation` to `/api/student/stats`
- `backend/app/api/routes/admin.py` - Added `pourcentage` and `justification` to StudentResponse schema

### 2. PDF Download Endpoint
**New Endpoint:** `GET /api/n8n/pdfs/download/{pdf_id}`
**File:** `backend/app/api/routes/n8n.py`

**Features:**
- Returns actual PDF file with proper Content-Type
- Sets download filename: `absences_{class}_{date}.pdf`
- Validates file exists on disk before serving
- Requires authentication (admin only via route protection)

**Implementation:**
```python
@router.get("/pdfs/download/{pdf_id}")
async def download_pdf(pdf_id: int, db: Session = Depends(get_db)):
    pdf = db.query(PDFAbsence).filter(PDFAbsence.id == pdf_id).first()
    if not pdf or not os.path.exists(pdf.pdf_path):
        raise HTTPException(status_code=404, detail="PDF not found")
    
    filename = f"absences_{pdf.class_name}_{pdf.date}.pdf"
    return FileResponse(pdf.pdf_path, media_type="application/pdf", filename=filename)
```

---

## Navigation Updates

**File:** `frontend/components/common/RoleNavBar.tsx`

**Added:**
- "Rapports PDF" link in admin navigation menu
- Positioned after "Analytique"
- Uses same styling as other admin links

---

## Data Flow

### Workflow 4 (AI Score):
1. **N8N** (6 PM daily):
   - Queries absences from PostgreSQL
   - Calls OpenRouter API (Gemma-3-27B)
   - AI calculates score + generates explanation
   - Updates `students.pourcentage` and `students.justification`

2. **SmartPresence Backend**:
   - Exposes fields via `/api/student/stats` and `/api/admin/students`

3. **Frontend**:
   - Student dashboard: Displays AI score card if available
   - Admin table: Shows score in dedicated column

### Workflow 5 (Daily PDFs):
1. **N8N** (11:59 PM daily):
   - Queries today's absences by class
   - Generates HTML table
   - Converts to PDF via Gotenberg
   - Uploads to SmartPresence: `POST /api/upload`

2. **SmartPresence Backend**:
   - Saves PDF to `/app/storage/n8n_pdfs/`
   - Records metadata in `pdfabsences` table
   - Serves PDFs via `/api/n8n/pdfs/download/{id}`

3. **Frontend** (`/admin/reports`):
   - Lists recent PDFs from `/api/n8n/pdfs/recent`
   - Allows filtering by class
   - Downloads via browser fetch API

---

## Testing Instructions

### Test AI Score Display:
1. Manually insert test data:
```sql
UPDATE students SET pourcentage = 85, justification = 'Excellent taux de présence avec quelques absences justifiées. Tendance positive.' WHERE id = 1;
```

2. Login as student (user linked to student ID 1)
3. Visit `/student` dashboard
4. Verify AI score card appears with:
   - Score: 85/100
   - Green color
   - Progress bar at 85%
   - Full explanation text

5. Login as admin
6. Visit `/admin/students`
7. Verify "Score IA" column shows 85 with sparkles icon
8. Click sparkles to see explanation popup

### Test PDF Reports:
1. Manually create test PDF:
```bash
docker exec smartpresence_backend bash -c "echo 'Test PDF' > /app/storage/n8n_pdfs/test.pdf"
```

2. Insert test record:
```sql
INSERT INTO pdfabsences (class_name, date, pdf_path, created_at) 
VALUES ('FS202', '2025-12-21', '/app/storage/n8n_pdfs/test.pdf', NOW());
```

3. Login as admin
4. Visit `/admin/reports`
5. Verify:
   - Test PDF appears in list
   - Class filter works
   - Download button triggers file download

---

## Production Checklist

- [x] Backend endpoints expose AI score fields
- [x] Student dashboard displays AI score card
- [x] Admin students table shows AI score column
- [x] Admin reports page created
- [x] PDF download endpoint implemented
- [x] Navigation updated with Reports link
- [x] Backend restarted successfully
- [ ] N8N Workflow 4 configured and activated
- [ ] N8N Workflow 5 configured and activated
- [ ] Test with real N8N-generated scores
- [ ] Test with real N8N-generated PDFs

---

## Files Modified/Created

### Backend:
- ✅ `backend/app/api/routes/student.py` - Added AI score to stats endpoint
- ✅ `backend/app/api/routes/admin.py` - Added AI score to StudentResponse
- ✅ `backend/app/api/routes/n8n.py` - Added PDF download endpoint

### Frontend:
- ✅ `frontend/app/(dashboard)/student/page.tsx` - Added AI score card
- ✅ `frontend/app/(dashboard)/admin/students/page.tsx` - Added Score IA column
- ✅ `frontend/app/(dashboard)/admin/reports/page.tsx` - **NEW** PDF reports page
- ✅ `frontend/components/common/RoleNavBar.tsx` - Added Reports link

---

## Next Steps

1. **Colleague configures N8N workflows** (per N8N_COLLEAGUE_INSTRUCTIONS.md)
2. **Activate Workflow 4** - Daily AI scoring at 6 PM
3. **Activate Workflow 5** - Daily PDF generation at 11:59 PM
4. **Verify end-to-end flow**:
   - Wait for 6 PM → Check student sees AI score
   - Wait for 11:59 PM → Check admin can download PDF
5. **Monitor logs** for any N8N webhook errors

---

## Support

For N8N configuration issues, see:
- `N8N_COLLEAGUE_INSTRUCTIONS.md` - Setup guide
- `N8N_INTEGRATION.md` - Technical integration details
- `n8n_config.txt` - Auto-generated credentials

For frontend bugs, check:
- Browser console for API errors
- Network tab for failed requests
- Backend logs: `docker logs smartpresence_backend`
